name: "Infra-as-code-checks"
on:
  pull_request:
    branches: [ main ]
  merge_group:
    types: [checks_requested]
env:
  TF_VERSION: "1.2.8"

jobs:
  run_tests:
    runs-on: ubuntu-latest
    name: Run tests
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          # Grab the last 50 commits. Later on we need to a git diff, and it's
          # very likely that two commits involved will be inside the last 50
          fetch-depth: 50

      - name: Install Ruby and gems
        uses: ruby/setup-ruby@d3c9825d67b0d8720afdfdde5af56c79fdb38d16 # v1.117.0
        with:
          bundler-cache: true
          working-directory: infra/

      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{env.TF_VERSION}}

      - name: Check Terraform style
        id: tf_fmt
        run: |
          terraform fmt -write=false -diff=true -list=true -recursive -check

      - name: Validate Terraform syntax
        env:
          BASE_REF: ${{github.event.pull_request.base.sha}}
          HEAD_REF: ${{github.event.pull_request.head.sha}}
        run: |
          set -e -u -o pipefail

          modified="$(ruby ./infra/scripts/find-altered-tf-deployments-and-modules.rb "${BASE_REF}" "${HEAD_REF}")"

          echo "$(echo "${modified}" | wc -l) modified Terraform deployments and modules"
          echo "${modified}"

          while IFS= read -r dir
          do
            echo "Validating ${dir}"

            terraform -chdir="${dir}" init -backend=false
            terraform -chdir="${dir}" validate
          done <<< "$modified"

      - name: Lint Terraform
        id: checkov
        uses: bridgecrewio/checkov-action@d403349a9193cf87f58f18a0f09aab1e9e058bde #v12.2552.0 
        with:
          directory: infra/
          framework: terraform
          quiet: true #Only show failed checks
          external_checks_dirs: infra/checkov/

      - name: Lint shell scripts
        run: |
          # we don't have non-alpha-numeric file names
          # shellcheck disable=SC2038
          find . -type f \
            -name "*.sh" \
            -not \
              -path "*/.terraform/*" \
          | xargs -L1 shellcheck

      - name: Lint shell scripts in GitHub actions
        run: |
          # This is not the usual/best way to get the script directory.
          # We need to do this here because GitHub Actions writes the
          # content of script blocks like these to a temp directory,
          # which means the source code directory and the directory
          # in which the script reside are different
          script_dir="$(readlink -f "$(dirname .github)")"

          while IFS= read -r -d '' workflow
          do
            for path in $(yq '.jobs[] | .steps[] | select(.|has("run")) | .run | "."+(path | join("."))' "${script_dir}/${workflow}");
            do
              pushd "$(mktemp -d)" >/dev/null || exit
                  workflow_name="$(basename "${script_dir}/${workflow}")"
                  file="${workflow_name}__${path}"
                  touch "${file}"
                  yq "${path}" "${script_dir}/${workflow}" > "${file}"
                  shellcheck -s bash "${file}"
              popd >/dev/null || exit
            done
          done <  <(find ".github/workflows" -type f \( -name "*.yml" -or -name "*.yaml" \) -print0)

      - name: Run Terraform specs
        working-directory: infra/
        run: bundle exec rspec
