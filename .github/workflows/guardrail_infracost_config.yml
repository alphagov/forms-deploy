name: "Guardrail: Infracost config sync"

on:
  pull_request:
    branches: [main]
    paths:
      - "infra/**"
      - ".github/workflows/guardrail_infracost_config.yml"
      - "infracost.yml"

jobs:
  check_infracost_config:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    name: Check infracost config is up to date
    steps:
      - name: Checkout code
        uses: actions/checkout@71cf2267d89c5cb81562390fa70a37fa40b1305e # v5.0.0

      - name: Initialise mise
        uses: jdx/mise-action@be3be2260bc02bc3fbf94c5e2fed8b7964baf074 # v3.4.0
        with:
          install: false
      - name: Fetch tool versions from mise
        id: tool-versions
        run: |
          echo "infracost=$(mise current infracost)" >> "$GITHUB_OUTPUT"
          echo "ruby=$(mise current ruby)" >> "$GITHUB_OUTPUT"

      - name: Set up Ruby
        uses: ruby/setup-ruby@8aeb6ff8030dd539317f8e1769a044873b56ea71 # v1.268.0
        with:
          ruby-version: ${{ steps.tool-versions.outputs.ruby }}
      - name: Setup Infracost
        uses: infracost/actions/setup@e9d6e6cd65e168e76b0de50ff9957d2fe8bb1832 # v3.0.1
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}
          currency: GBP
          version: ${{ steps.tool-versions.outputs.infracost }}

      - name: Generate infracost config and check for changes
        run: |
          # Generate new config
          ./infra/scripts/generate-infracost-config.rb -o infracost-generated.yml

          # Check if it differs from current
          if ! diff -q infracost.yml infracost-generated.yml > /dev/null; then
            echo "ERROR: infracost.yml is out of sync with infrastructure changes"
            echo ""
            echo "Differences found:"
            diff infracost.yml infracost-generated.yml || true
            echo ""
            echo "To fix this, run: ./infra/scripts/generate-infracost-config.rb -o infracost.yml"
            echo "If this script does not fix this issue, ensure you are using the infracost version specified in .mise.toml"
            exit 1
          else
            echo "infracost.yml is up to date"
          fi

      - name: Update or remove comment based on status
        if: always()
        env:
          COMMENT_MARKER: "<!-- guardrail: infracost config out of sync -->"
          GH_TOKEN: ${{ github.token }}
        run: |
          # Remove any existing comments first
          # shellcheck disable=SC2016 # $ENV is not a shell variable in the context of the jq expression
          old_comment_ids=$(gh api "repos/{owner}/{repo}/issues/${{github.event.pull_request.number}}/comments" --jq 'map(select((.user.login == "github-actions[bot]") and (.body | endswith($ENV.COMMENT_MARKER + "\n")))) | .[].id')
          for comment_id in $old_comment_ids; do
            gh api -X DELETE "repos/{owner}/{repo}/issues/comments/${comment_id}"
          done

          # Only add comment if the check failed
          if [ "${{ job.status }}" = "failure" ]; then
            # shellcheck disable=SC2296
            # shellcheck disable=SC2016
            cat <<EOF > "${{runner.temp}}/pr-comment.md"
          > [!WARNING]
          > Your changes to \`infra/\` require updating \`infracost.yml\`.
          >
          > Please run the following command and commit the result:
          >
          > \`\`\`
          > ./infra/scripts/generate-infracost-config.rb -o infracost.yml
          > \`\`\`

          <details>
          <summary>Potential reasons why you're seeing this message</summary>

          - You've added / renamed a terraform root
          - You've added / renamed a module, or used a module within a root for the first time
          - Someone else previously merged infra changes but forgot to update \`infracost.yml\`
          - Potentially version skew between the \`infracost\` version you're using and the one specified in \`.mise.toml\` (super unlikely)
          </details>

          ${COMMENT_MARKER}
          EOF

            gh pr comment "${{github.event.pull_request.html_url}}" --body-file "${{runner.temp}}/pr-comment.md"
          fi
