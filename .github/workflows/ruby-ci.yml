name: "Ruby CI"
on:
  pull_request:
    branches: [main]
    paths:
      - "**.rb"
      - "**Gemfile"
      - "**Rakefile"
      - ".github/workflows/ruby-ci.yml"
      - "infra/**"
      - ".mise.toml"
  merge_group:
    types: [checks_requested]
  push:
    branches: [main]
jobs:
  setup:
    name: "Setup"
    runs-on: ubuntu-latest
    outputs:
      ruby-version: ${{ steps.set-ruby-version.outputs.ruby-version }}
      spec-matrix: ${{ steps.build-matrix.outputs.spec-matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493 # v5.0.0

      - name: Initialise mise and cache `hcl2json`
        uses: jdx/mise-action@be3be2260bc02bc3fbf94c5e2fed8b7964baf074 # v3.4.0
        with:
          install_args: hcl2json

      - name: Set Ruby version
        id: set-ruby-version
        run: |
          echo "ruby-version=$(mise current ruby)" >> "$GITHUB_OUTPUT"

      - name: Build spec matrix
        id: build-matrix
        run: |
          spec_dirs_json="$(find . -type d -name 'spec' -not -path '*vendor*' | sed 's|/spec$||g' | jq -Rnc '[inputs]')"
          echo "spec-matrix=$spec_dirs_json" >> "$GITHUB_OUTPUT"

  ruby-lint:
    name: "Ruby Lint"
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493 # v5.0.0
      - name: Install Ruby and gems at root
        uses: ruby/setup-ruby@ab177d40ee5483edb974554986f56b33477e21d0 # v1.265.0
        with:
          bundler-cache: true
          ruby-version: ${{needs.setup.outputs.ruby-version}}
      - name: Run rubocop
        run: make lint_ruby

  ruby-spec:
    name: "Rspec"
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      fail-fast: false
      matrix:
        spec_target: ${{ fromJSON(needs.setup.outputs.spec-matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493 # v5.0.0

      - name: Set up hcl2json
        uses: jdx/mise-action@be3be2260bc02bc3fbf94c5e2fed8b7964baf074 # v3.4.0
        with:
          install_args: hcl2json

      - name: "Install Ruby and gems in ${{matrix.spec_target}}"
        uses: ruby/setup-ruby@ab177d40ee5483edb974554986f56b33477e21d0 # v1.265.0
        with:
          bundler-cache: true
          ruby-version: ${{needs.setup.outputs.ruby-version}}
          working-directory: "${{matrix.spec_target}}"

      - name: Run specs
        run: |
          cd "${{matrix.spec_target}}"
          bundle exec rspec
