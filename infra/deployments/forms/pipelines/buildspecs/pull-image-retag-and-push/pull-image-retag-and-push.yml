version: 0.2
env:
  exported-variables:
    - PROMOTED_IMAGE_TAG
phases:
  pre_build:
    commands:
      - echo "Log in to Amazon ECR repository ${CONTAINER_REGISTRY}"
      - aws ecr get-login-password --region eu-west-2 | docker login --username AWS --password-stdin "${CONTAINER_REGISTRY}"

      - |
         CURRENT_IMAGE_URI="${CONTAINER_IMAGE_URI}"
         CURRENT_IMAGE_TAG="$(echo "${CONTAINER_IMAGE_URI}" | cut -d':' -f2)"
         echo "Current image uri is ${CURRENT_IMAGE_URI}"
         echo "Current image tag is ${CURRENT_IMAGE_TAG}"
         echo "Using sed expression ${RETAG_SED_EXPRESSION}"

      - |
         set -x
         EPOCH_SECONDS="$(date '+%s')"
         export EPOCH_SECONDS
         # shellcheck disable=SC2016 # envsubst expects an environment variable name in shell format
         PROMOTED_IMAGE_TAG="$(echo "${CURRENT_IMAGE_TAG}" | sed "${RETAG_SED_EXPRESSION}" | envsubst '${EPOCH_SECONDS}')"
         PROMOTED_IMAGE_URI="${CONTAINER_REGISTRY}/${IMAGE_NAME}:${PROMOTED_IMAGE_TAG}"
         echo "New image tag will be ${PROMOTED_IMAGE_TAG}"
         echo "New image uri will be ${PROMOTED_IMAGE_URI}"
  build:
    commands:
      - |
         docker pull "${CURRENT_IMAGE_URI}"
         docker tag "${CURRENT_IMAGE_URI}" "${PROMOTED_IMAGE_URI}"
         docker push "${PROMOTED_IMAGE_URI}"

         if [ "${APPLY_LATEST_TAG}" = true ]; then
            echo "Applying 'latest' tag to ${CURRENT_IMAGE_URI}"
            LATEST_IMAGE_URI="${CONTAINER_REGISTRY}/${IMAGE_NAME}:latest"
            docker tag "${CURRENT_IMAGE_URI}" "${LATEST_IMAGE_URI}"
            docker push "${LATEST_IMAGE_URI}"
         fi
