<section class="pipeline">
    <span class="govuk-caption-l">Pipeline</span>
    <h2 class="govuk-heading-l">
        <%= pipeline.name %>
        <%= erb :'partials/label', :locals => { status: pipeline.status } %>
    </h2>

    <p class="govuk-body">
        <strong>Last execution time</strong> <%= pipeline.last_started_at.strftime("%d/%m/%y %H:%M") %>
    </p>

    <details class="govuk-details">
      <summary class="govuk-details__summary">
        <span class="govuk-details__summary-text">Viewing this pipeline in AWS CodePipeline</span>
      </summary>

      <div class="govuk-details__text">
        <p class="govuk-body">
        You can view this pipeline in AWS CodePipeline by logging into the relevant account and visiting
        </p>

        <p class="govuk-body">
          <a href="https://eu-west-2.console.aws.amazon.com/codesuite/codepipeline/pipelines/<%= pipeline.name %>/view?region=eu-west-2">https://eu-west-2.console.aws.amazon.com/codesuite/codepipeline/pipelines/<%= pipeline.name %>/view?region=eu-west-2</a>
        </p>

        <p class="govuk-body">
          You can also run the following in your terminal to log into the account and open the page
        </p>

        <code class="code" id="code-open-<%= slugify(pipeline.name) %>">AWS_VAULT="" gds aws <%= pipeline.gds_cli_role %> -- open "https://eu-west-2.console.aws.amazon.com/codesuite/codepipeline/pipelines/<%= pipeline.name %>/view?region=eu-west-2"</code>

        <p class="govuk-body">
          <button class="govuk-button govuk-button--secondary" onclick="navigator.clipboard.writeText(document.getElementById('code-open-<%= slugify(pipeline.name) %>').innerText)">Copy code</button>
        </p>
      </div>
    </details>

    <details class="govuk-details">
        <summary class="govuk-details__summary">
            <span class="govuk-details__summary-text">About this pipeline run</span>
        </summary>

        <div class="govuk-details__text">
            <dl class="govuk-summary-list">
                <div class="govuk-summary-list__row">
                <dt class="govuk-summary-list__key">
                    Execution ID
                </dt>
                <dd class="govuk-summary-list__value">
                    <%= pipeline.execution_id %>
                </dd>
                </div>
            </dl>

            <table class="govuk-table">
                <caption class="govuk-table__caption govuk-table__caption--m">Artifacts</caption>

                <thead>
                    <tr class="govuk-tabke__row">
                        <th scope="col" class="govuk-table__header">Name</th>
                        <th scope="col" class="govuk-table__header">Revision</th>
                        <th scope="col" class="govuk-table__header">Summary</th>
                    </tr>
                </thead>


                <tbody class="govuk-table__body">
                    <% if pipeline.artifacts.length == 0 %>
                        <tr class="govuk-table__row">
                          <th scope="row" class="govuk-table__header" colspan="2">
                              No artifacts
                          </th>
                        </tr>
                    <% else %>
                        <% pipeline.artifacts.each do |artifact| %>
                            <tr class="govuk-table__row">
                                <th scope="row" class="govuk-table__header"><%= artifact.name %></th>
                                <td class="govuk-table__cell"><%= artifact.revision_id %></td>
                                <td class="govuk-table__cell">
                                    <p style="text-wrap: balance">
                                    <%= artifact.revision_summary.strip %>
                                    </p>
                                </td>
                            </tr>
                        <% end %>
                    <% end %>
                </tbody>
            </table>

            <table class="govuk-table">
                <caption class="govuk-table__caption govuk-table__caption--m">Variables</caption>

                <thead>
                    <tr class="govuk-tabke__row">
                        <th scope="col" class="govuk-table__header">Name</th>
                        <th scope="col" class="govuk-table__header">Value</th>
                    </tr>
                </thead>


                <tbody class="govuk-table__body">
                    <% if pipeline.variables.length == 0 %>
                        <tr class="govuk-table__row">
                          <th scope="row" class="govuk-table__header" colspan="2">
                              No variables
                          </th>
                        </tr>
                    <% else %>
                        <% pipeline.variables.each do |var| %>
                            <tr class="govuk-table__row">
                                <th scope="row" class="govuk-table__header"><%= var.name %></th>
                                <td class="govuk-table__cell"><%= var.resolved_value %></td>
                            </tr>
                        <% end %>
                    <% end %>
                </tbody>
            </table>
        </div>
    </details>

    <table class="govuk-table">
        <caption class="govuk-table__caption govuk-table__caption--m">Stages</caption>

        <thead>
            <tr class="govuk-tabke__row">
                <th scope="col" class="govuk-table__header">Stage</th>
                <th scope="col" class="govuk-table__header">Status</th>
                <th scope="col" class="govuk-table__header"><!-- Error messages, no visual header --></th>
            </tr>
        </thead>

        <tbody class="govuk-table__body">
            <% pipeline.stages.each do |stage| %>
                <tr class="govuk-table__row">
                  <th scope="row" class="govuk-table__header"><%= stage.name %></th>
                  <td class="govuk-table__cell govuk-!-width-one-quarter">
                      <% if stage.outdated %>
                          <%= erb :'partials/label', :locals => {status: "Not Started"} %>
                      <% else %>
                          <%= erb :'partials/label', :locals => { status: stage.status } %>
                      <% end %>
                  </td>
                  <td class="govuk-table__cell">
                    <% if stage.error_message %>
                      <%= stage.error_message %>
                    <% end %>
                  </td>
                </tr>
            <% end %>
        </tbody>
    </table>
</section>
